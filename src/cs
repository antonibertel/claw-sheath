#!/bin/bash

# Determine our location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
ENV_FILE="${SCRIPT_DIR}/sheath-env.sh"

export SHELL="$SCRIPT_DIR/cs"
export BASH_ENV="$ENV_FILE"

# If we are invoked as an interactive/login shell or with bash flags (e.g. by an agent's PTY)
if [[ $# -eq 0 ]] || [[ "$1" == -* ]]; then
    # Bash only auto-sources BASH_ENV for non-interactive shells (like bash -c).
    # If it's an interactive shell, we explicitly inject our environment.
    if [[ -f "$ENV_FILE" ]]; then
        source "$ENV_FILE"
    else
        echo -e "\x1b[31mclaw-sheath error:\x1b[0m Environment file not found at $ENV_FILE" >&2
        exit 1
    fi
    exec bash "$@"
else
    # Invoked as a launcher wrapper (e.g. `cs openclaw`). 
    # Do NOT source ENV_FILE here, otherwise we pollute the environment with BASH_FUNC_* 
    # which crashes Node/Go programs that strictly parse env vars!
    if [[ $# -eq 0 ]]; then
        echo "Usage: cs <command_to_protect>"
        echo "Example: cs openclaw agent --agent main"
        exit 1
    fi
    exec "$@"
fi
